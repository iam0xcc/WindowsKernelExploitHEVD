# Windows kernel exploit analysis series part 2 任意内存覆盖漏洞 #
by 妖孽

1，任意内存覆盖漏洞原理

顾名思义，给出任何内存地址，并在该地址上填写我想写的任意内容。通过精心构造目标地址和内容，可实现想要的效果。

任意内存覆盖漏洞触发原理：
	NTSTATUS
	TriggerArbitraryWrite(
  	  _In_ PWRITE_WHAT_WHERE UserWriteWhatWhere
	)
	{
    PULONG_PTR What = NULL;
    PULONG_PTR Where = NULL;
    NTSTATUS Status = STATUS_SUCCESS;

    PAGED_CODE();

    __try
    {
        //
        // Verify if the buffer resides in user mode

        ProbeForRead((PVOID)UserWriteWhatWhere, sizeof(WRITE_WHAT_WHERE), (ULONG)__alignof(UCHAR));
		//UserWriteWhatWhere是3环给过来的数据，可以精心构造这里面的数据
        What = UserWriteWhatWhere->What;
        Where = UserWriteWhatWhere->Where;

        DbgPrint("[+] UserWriteWhatWhere: 0x%p\n", UserWriteWhatWhere);
        DbgPrint("[+] WRITE_WHAT_WHERE Size: 0x%X\n", sizeof(WRITE_WHAT_WHERE));
        DbgPrint("[+] UserWriteWhatWhere->What: 0x%p\n", What);
        DbgPrint("[+] UserWriteWhatWhere->Where: 0x%p\n", Where);

	#ifdef SECURE  安全的写法
        为什么安全呢？3环传递给0环的数据，*(Where) = *(What)进行这样的操作，如果不进行校验是一件非常不安全的事。
		ProbeForRead和ProbeForWrite的作用是检查内存在3环是否可用，如果传递的地址是内核地址，就会抛出异常。这样就把要修改的地址限定在了3环了，而影响不到内核，从而缓解了内核漏洞。

        // Secure Note: This is secure because the developer is properly validating if address
        // pointed by 'Where' and 'What' value resides in User mode by calling ProbeForRead()/
        // ProbeForWrite() routine before performing the write operation
		//

        ProbeForRead((PVOID)What, sizeof(PULONG_PTR), (ULONG)__alignof(UCHAR));
        ProbeForWrite((PVOID)Where, sizeof(PULONG_PTR), (ULONG)__alignof(UCHAR));

        *(Where) = *(What);
	#else
        DbgPrint("[+] Triggering Arbitrary Write\n");

        // Vulnerability Note: This is a vanilla Arbitrary Memory Overwrite vulnerability
        // because the developer is writing the value pointed by 'What' to memory location
        // pointed by 'Where' without properly validating if the values pointed by 'Where'
        // and 'What' resides in User mode

        
	#endif
    }
    __except (EXCEPTION_EXECUTE_HANDLER)
    {
        Status = GetExceptionCode();
        DbgPrint("[-] Exception Code: 0x%X\n", Status);
    }
    // There is one more hidden vulnerability. Find it out.
    return Status;
}

*(Where) = *(What);wehre和what都是从3环传递进去的，只是覆盖了where的内容为what，覆盖到哪个内核地址，what内容有怎么设计，这些都很重要。

what内容设计为shellcode后，如何触发执行，这些都是问题。



